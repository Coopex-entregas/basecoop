from flask import request, redirect, url_for, flash, render_template, session
from models import db, Entrega, Cooperado
from datetime import datetime

@app.route('/editar_entrega/<int:entrega_id>', methods=['GET', 'POST'])
def editar_entrega(entrega_id):
    entrega = Entrega.query.get_or_404(entrega_id)
    user_tipo = session.get('usuario_tipo', 'cooperado')  # 'adm' ou 'cooperado'

    if request.method == 'POST':
        # Pega dados do formulário (se enviados)
        descricao = request.form.get('descricao')
        valor = request.form.get('valor')
        cooperado_id = request.form.get('cooperado_id')
        status_pagamento = request.form.get('status_pagamento')
        status_entrega = request.form.get('status_entrega')

        # Atualiza campos se for admin
        if user_tipo == 'adm':
            if descricao is not None:
                entrega.descricao = descricao

            if valor is not None:
                try:
                    entrega.valor = float(valor)
                except ValueError:
                    flash("Valor inválido.", "error")
                    return redirect(url_for('editar_entrega', entrega_id=entrega_id))

            if cooperado_id:
                if cooperado_id.isdigit():
                    entrega.cooperado_id = int(cooperado_id)
                    entrega.hora_atribuida = datetime.utcnow()
                else:
                    entrega.cooperado_id = None
                    entrega.hora_atribuida = None

        # Ambos (adm e cooperado) podem alterar os status
        if status_pagamento in ['pendente', 'pago']:
            entrega.status_pagamento = status_pagamento

        if status_entrega in ['pendente', 'em rota', 'entregue']:
            entrega.status_entrega = status_entrega

        db.session.commit()
        flash("Entrega atualizada com sucesso.", "success")

        if user_tipo == 'adm':
            return redirect(url_for('dashboard'))
        else:
            return redirect(url_for('dashboard_cooperado'))

    # GET request - renderiza página de edição
    cooperados = Cooperado.query.order_by(Cooperado.nome).all() if user_tipo == 'adm' else []
    return render_template('editar_entrega.html', entrega=entrega, cooperados=cooperados, user_tipo=user_tipo)
