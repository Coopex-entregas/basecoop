{% extends "base.html" %}

{% block title %}Editar Entrega - Coopex{% endblock %}

{% block content %}
<div class="header">
    <h1>
        {% if user_tipo == 'adm' %}
            Editar Entrega #{{ entrega.id }}
        {% else %}
            Atualizar Status da Entrega #{{ entrega.id }}
        {% endif %}
    </h1>
    <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="btn-secondary">
            <span style="margin-right: 8px;">←</span>
            Voltar ao Dashboard
        </a>
    </div>
</div>

<div class="content">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for msg in messages %}
                {% if "sucesso" in msg or "atualizado" in msg %}
                    <div class="alert alert-success">{{ msg }}</div>
                {% else %}
                    <div class="alert alert-error">{{ msg }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div style="max-width: 600px; margin: 0 auto;">
        <!-- Informações da Entrega -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="color: #4a5568; margin-bottom: 15px; font-size: 1.2rem;">📋 Informações da Entrega</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; color: #718096;">
                <div>
                    <strong>ID:</strong> #{{ entrega.id }}
                </div>
                <div>
                    <strong>Pedido em:</strong> {{ entrega.hora_pedido.strftime('%d/%m/%Y %H:%M') }}
                </div>
                {% if entrega.hora_atribuida %}
                <div>
                    <strong>Atribuído em:</strong> {{ entrega.hora_atribuida.strftime('%d/%m/%Y %H:%M') }}
                </div>
                {% endif %}
                {% if user_tipo == 'cooperado' %}
                <div>
                    <strong>Descrição:</strong> {{ entrega.descricao }}
                </div>
                {% endif %}
            </div>
        </div>

        <form method="POST" action="{{ url_for('editar_entrega', entrega_id=entrega.id) }}">
            <!-- Enviar hora_pedido no POST -->
            <input type="hidden" name="hora_pedido" value="{{ entrega.hora_pedido.strftime('%Y-%m-%dT%H:%M') }}">

            {% if user_tipo == 'adm' %}
                <!-- Campos para Administrador -->
                <div class="form-group">
                    <label for="descricao">Descrição da Entrega:</label>
                    <input type="text" id="descricao" name="descricao" value="{{ entrega.descricao }}" required>
                </div>

                <div class="form-group">
                    <label for="valor">Valor da Entrega:</label>
                    <input type="number" id="valor" name="valor" step="0.01" value="{{ entrega.valor or 0 }}" required>
                </div>

                <div class="form-group">
                    <label for="cooperado_id">Cooperado Responsável:</label>
                    <select id="cooperado_id" name="cooperado_id">
                        <option value="">-- Nenhum cooperado atribuído --</option>
                        {% for c in cooperados %}
                        <option value="{{ c.id }}" {% if entrega.cooperado_id == c.id %}selected{% endif %}>
                            {{ c.nome }}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #718096; font-size: 14px; margin-top: 5px; display: block;">
                        Alterar o cooperado atualizará automaticamente a hora de atribuição
                    </small>
                </div>
            {% else %}
                <!-- Visualização para Cooperado -->
                <div style="background: #e6fffa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #38b2ac;">
                    <h4 style="color: #234e52; margin-bottom: 10px;">📦 Descrição da Entrega</h4>
                    <p style="color: #234e52; font-size: 1.1rem;">{{ entrega.descricao }}</p>
                </div>
            {% endif %}

            <!-- Status de Pagamento (disponível para ambos) -->
            <div class="form-group">
                <label for="status_pagamento">Status do Pagamento:</label>
                <select id="status_pagamento" name="status_pagamento" required>
                    <option value="pendente" {% if entrega.status_pagamento == 'pendente' %}selected{% endif %}>
                        💳 Pendente
                    </option>
                    <option value="pago" {% if entrega.status_pagamento == 'pago' %}selected{% endif %}>
                        ✅ Pago
                    </option>
                </select>
            </div>

            <!-- Status de Entrega (disponível para ambos) -->
            <div class="form-group">
                <label for="status_entrega">Status da Entrega:</label>
                <select id="status_entrega" name="status_entrega" required>
                    <option value="pendente" {% if entrega.status_entrega == 'pendente' %}selected{% endif %}>
                        ⏳ Pendente
                    </option>
                    <option value="em rota" {% if entrega.status_entrega == 'em rota' %}selected{% endif %}>
                        🚚 Em Rota
                    </option>
                    <option value="entregue" {% if entrega.status_entrega == 'entregue' %}selected{% endif %}>
                        ✅ Entregue
                    </option>
                </select>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="submit" class="btn" style="flex: 1;">
                    <span style="margin-right: 8px;">💾</span>
                    {% if user_tipo == 'adm' %}
                        Salvar Alterações
                    {% else %}
                        Atualizar Status
                    {% endif %}
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="flex: 1; text-align: center;">
                    Cancelar
                </a>
            </div>
        </form>

        <!-- Dicas para o usuário -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-top: 30px;">
            <h3 style="color: #4a5568; margin-bottom: 15px; font-size: 1.1rem;">💡 Dicas</h3>
            {% if user_tipo == 'adm' %}
            <ul style="color: #718096; line-height: 1.6;">
                <li>Altere a descrição para adicionar mais detalhes sobre a entrega</li>
                <li>Atribua ou reatribua a entrega para diferentes cooperados conforme necessário</li>
                <li>Acompanhe o status de pagamento e entrega para controle administrativo</li>
                <li>A hora de atribuição é atualizada automaticamente quando você muda o cooperado</li>
            </ul>
            {% else %}
            <ul style="color: #718096; line-height: 1.6;">
                <li>Marque "Em Rota" quando sair para fazer a entrega</li>
                <li>Marque "Entregue" apenas quando a entrega for concluída</li>
                <li>Atualize o status de pagamento conforme receber o pagamento</li>
                <li>Mantenha os status sempre atualizados para melhor controle</li>
            </ul>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
