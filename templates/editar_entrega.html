from flask import request, redirect, url_for, flash, render_template, session
from models import db, Entrega, Cooperado
from datetime import datetime

@app.route('/editar_entrega/<int:entrega_id>', methods=['GET', 'POST'])
def editar_entrega(entrega_id):
    entrega = Entrega.query.get_or_404(entrega_id)
    user_tipo = session.get('usuario_tipo', 'cooperado')  # Ajuste conforme sua sessão

    if request.method == 'POST':
        try:
            # Campos opcionais
            descricao = request.form.get('descricao')
            valor = request.form.get('valor')
            cooperado_id = request.form.get('cooperado_id')
            status_pagamento = request.form.get('status_pagamento')
            status_entrega = request.form.get('status_entrega')

            if user_tipo == 'adm':
                if descricao is not None and descricao.strip() != '':
                    entrega.descricao = descricao.strip()

                if valor is not None and valor.strip() != '':
                    try:
                        entrega.valor = float(valor)
                    except ValueError:
                        flash("Valor inválido. Informe um número válido.", "error")
                        return redirect(url_for('editar_entrega', entrega_id=entrega_id))
                else:
                    entrega.valor = 0.0  # Ou mantem o valor anterior, se preferir

                if cooperado_id:
                    if cooperado_id.isdigit():
                        entrega.cooperado_id = int(cooperado_id)
                        entrega.hora_atribuida = datetime.utcnow()
                    else:
                        entrega.cooperado_id = None
                        entrega.hora_atribuida = None

            # Atualiza status de pagamento se enviado e válido
            if status_pagamento in ['pendente', 'pago']:
                entrega.status_pagamento = status_pagamento

            # Atualiza status de entrega se enviado e válido
            if status_entrega in ['pendente', 'em rota', 'entregue']:
                entrega.status_entrega = status_entrega

            db.session.commit()
            flash("Entrega atualizada com sucesso.", "success")

            if user_tipo == 'adm':
                return redirect(url_for('dashboard'))
            else:
                return redirect(url_for('dashboard_cooperado'))

        except Exception as e:
            db.session.rollback()
            flash(f"Erro ao atualizar entrega: {str(e)}", "error")
            return redirect(url_for('editar_entrega', entrega_id=entrega_id))

    cooperados = Cooperado.query.order_by(Cooperado.nome).all() if user_tipo == 'adm' else []
    return render_template('editar_entrega.html', entrega=entrega, cooperados=cooperados, user_tipo=user_tipo)
