from flask import request, redirect, url_for, flash, render_template, session
from models import db, Entrega, Usuario
from datetime import datetime

@app.route('/editar_entrega/<int:entrega_id>', methods=['GET', 'POST'])
def editar_entrega(entrega_id):
    entrega = Entrega.query.get_or_404(entrega_id)
    user_tipo = session.get('usuario_tipo', 'cooperado')

    if request.method == 'POST':
        # Coleta campos do formul√°rio
        status_pagamento = request.form.get('status_pagamento')
        status_entrega = request.form.get('status_entrega')

        # Apenas admins podem alterar outros campos
        if user_tipo == 'adm':
            entrega.descricao = request.form.get('descricao', entrega.descricao)
            valor = request.form.get('valor')
            try:
                entrega.valor = float(valor)
            except (ValueError, TypeError):
                entrega.valor = 0

            cooperado_id = request.form.get('cooperado_id')
            if cooperado_id:
                if cooperado_id.isdigit():
                    entrega.cooperado_id = int(cooperado_id)
                    entrega.hora_atribuida = datetime.utcnow()
                else:
                    entrega.cooperado_id = None
                    entrega.hora_atribuida = None

        # Ambos podem alterar status
        if status_pagamento in ['pendente', 'pago']:
            entrega.status_pagamento = status_pagamento
        if status_entrega in ['pendente', 'em rota', 'entregue']:
            entrega.status_entrega = status_entrega

        db.session.commit()
        flash("Entrega atualizada com sucesso.", "success")
        if user_tipo == 'adm':
            return redirect(url_for('dashboard'))
        else:
            return redirect(url_for('dashboard_cooperado'))

    cooperados = Usuario.query.filter_by(tipo='cooperado').order_by(Usuario.nome).all() if user_tipo == 'adm' else []
    return render_template('editar_entrega.html', entrega=entrega, cooperados=cooperados, user_tipo=user_tipo)
