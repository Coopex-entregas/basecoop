{% extends "base.html" %}

{% block title %}Painel Administrativo - Coopex{% endblock %}

{% block content %}
<div class="header">
    <h1>Painel Administrativo COOPEX</h1>
    <p style="color: #718096; margin-bottom: 20px;">Bem-vindo, {{ session['usuario_nome'] }}!</p>
    
    <div class="nav-links">
        <a href="{{ url_for('cadastrar_cooperado') }}">
            <span style="margin-right: 8px;">👤</span>
            Cadastrar Cooperado
        </a>
        <a href="{{ url_for('cadastrar_entrega') }}">
            <span style="margin-right: 8px;">📦</span>
            Nova Entrega
        </a>
        <a href="{{ url_for('exportar_entregas') }}" class="btn" style="margin-left: 10px;">
            <span style="margin-right: 8px;">📊</span>
            Exportar Entregas
        </a>
        <a href="{{ url_for('logout') }}" class="logout">
            <span style="margin-right: 8px;">🚪</span>
            Sair
        </a>
    </div>
</div>

<!-- Estatísticas -->
<section style="margin: 20px 0; padding: 15px; background-color: #f7fafc; border: 1px solid #ccc; border-radius: 8px;">
    <h2>📊 Estatísticas Gerais</h2>
    <p><strong>Total de entregas hoje:</strong> {{ total_dia }}</p>
    <p><strong>Total de entregas no ano:</strong> {{ total_entregas_ano }}</p>
    <p><strong>Total ganho no mês:</strong> R$ {{ '%.2f' % total_valor_mes }}</p>

    <h3>💰 Ganhos por Cooperado no Mês</h3>
    {% if valores_por_cooperado %}
        <ul>
            {% for nome, valor in valores_por_cooperado %}
                <li>{{ nome }}: R$ {{ '%.2f' % valor }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Nenhum ganho registrado este mês.</p>
    {% endif %}
</section>

<!-- Filtro de data -->
<section style="margin: 20px 0; padding: 15px; background-color: #f7fafc; border: 1px solid #ccc; border-radius: 8px;">
    <form method="get" action="{{ url_for('dashboard') }}">
        <label for="data_filtro">Filtrar por data:</label>
        <input type="date" id="data_filtro" name="data_filtro" value="{{ data_filtro or '' }}">
        <button type="submit" class="btn">Filtrar</button>
    </form>
</section>

<!-- Entregas -->
<section style="margin: 20px 0; padding: 15px; background-color: #f7fafc; border: 1px solid #ccc; border-radius: 8px;">
    <h2 class="section-title">
        <span style="margin-right: 10px;">📦</span>
        Entregas do Dia
    </h2>

    {% if entregas %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Hora do Pedido</th>
                        <th>Cooperado</th>
                        <th>Status Pagamento</th>
                        <th>Status Entrega</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entrega in entregas %}
                    <tr>
                        <td>#{{ entrega.id }}</td>
                        <td>{{ entrega.descricao }}</td>
                        <td>R$ {{ '%.2f' % (entrega.valor or 0) }}</td>
                        <td>{{ entrega.hora_pedido|utc_to_brt }}</td>
                        <td>{{ entrega.cooperado.nome if entrega.cooperado else '---' }}</td>
                        <td>{{ entrega.status_pagamento }}</td>
                        <td>{{ entrega.status_entrega }}</td>
                        <td>
                            <a href="{{ url_for('editar_entrega', entrega_id=entrega.id) }}" class="btn">✏️</a>
                            <form action="{{ url_for('excluir_entrega', entrega_id=entrega.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir a entrega #{{ entrega.id }}?')">
                                <button type="submit" class="btn btn-danger">❌</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 20px; color: #718096;">
            <p>🚫 Nenhuma entrega registrada para este dia.</p>
            <a href="{{ url_for('cadastrar_entrega') }}" class="btn" style="margin-top: 15px;">Cadastrar Primeira Entrega</a>
        </div>
    {% endif %}
</section>

<!-- Motoboys em Espera -->
<section style="margin: 20px 0; padding: 15px; background-color: #f7fafc; border: 1px solid #ccc; border-radius: 8px;">
    <h2 class="section-title" style="margin-bottom: 10px;">
        <span style="margin-right: 10px;">🏍️</span>
        Motoboys em Espera
    </h2>

    <div id="lista-motoboys"></div>
    <button id="add-motoboy" class="btn" style="margin-top: 10px;">+ Adicionar Motoboy</button>
    <button id="limpar-motoboys" class="btn btn-danger" style="margin-top: 10px; margin-left: 10px;">Limpar Tudo</button>

    <script>
      const listaDiv = document.getElementById('lista-motoboys');
      const btnAdd = document.getElementById('add-motoboy');
      const btnLimpar = document.getElementById('limpar-motoboys');

      let motoboys = {{ motoboys_espera|tojson|safe }};

      function salvarLista() {
        fetch('/motoboys_espera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ motoboys })
        }).then(resp => resp.json())
          .then(data => {
            if(data.status !== 'ok') alert('Erro ao salvar lista!');
          });
      }

      function renderLista() {
        listaDiv.innerHTML = '';
        motoboys.forEach((nome, idx) => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = nome;
          input.placeholder = 'Nome do motoboy';
          input.style.marginBottom = '5px';
          input.style.width = '300px';
          input.oninput = () => {
            motoboys[idx] = input.value;
            if(input.value.trim() === '') {
              motoboys.splice(idx, 1);
              renderLista();
              salvarLista();
            } else {
              salvarLista();
            }
          };
          listaDiv.appendChild(input);
          listaDiv.appendChild(document.createElement('br'));
        });
      }

      btnAdd.onclick = () => {
        motoboys.push('');
        renderLista();
      };

      btnLimpar.onclick = () => {
        if(confirm('Deseja limpar toda a lista de motoboys em espera?')) {
          motoboys = [];
          renderLista();
          salvarLista();
        }
      };

      renderLista();
    </script>
</section>

{% endblock %}
