{% extends "base.html" %}

{% block title %}Dashboard Admin - Coopex{% endblock %}

{% block content %}
<div class="header">
    <h1>Dashboard Administrativo</h1>
    <p style="color: #718096; margin-bottom: 20px;">Bem-vindo, {{ session['usuario_nome'] }}!</p>
    
    <div class="nav-links">
        <a href="{{ url_for('cadastrar_cooperado') }}">
            <span style="margin-right: 8px;">üë§</span>
            Cadastrar Cooperado
        </a>
        <a href="{{ url_for('cadastrar_entrega') }}">
            <span style="margin-right: 8px;">üì¶</span>
            Nova Entrega
        </a>
        <a href="{{ url_for('exportar_entregas') }}" class="btn" style="margin-left: 10px;">
            <span style="margin-right: 8px;">üìä</span>
            Exportar Entregas
        </a>
        <a href="{{ url_for('logout') }}" class="logout">
            <span style="margin-right: 8px;">üö™</span>
            Sair
        </a>
    </div>
</div>

<!-- Filtro de data -->
<form method="get" action="{{ url_for('dashboard') }}" style="margin: 20px 0;">
  <label for="data_filtro">Filtrar por data:</label>
  <input type="date" id="data_filtro" name="data_filtro" value="{{ data_filtro or '' }}">
  <button type="submit">Filtrar</button>
</form>

<div class="content">
    <!-- Se√ß√£o de Fila de Espera -->
    <h2 class="section-title" style="margin-bottom: 20px;">
        <span style="margin-right: 10px;">‚è≥</span>
        Fila de Espera de Cooperados
    </h2>
    {% if fila_espera %}
        <div class="cooperados-list">
            {% for c in fila_espera %}
                <div class="cooperado-card" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #fffbe6; padding: 10px; border-radius: 6px; border: 1px solid #f0e68c;">
                    <div>
                        <div class="cooperado-name">{{ c.nome }}</div>
                        <div style="color: #a17c00; font-size: 14px;">
                            Na fila de espera
                        </div>
                    </div>
                    <form action="{{ url_for('alterar_fila_espera', cooperado_id=c.id) }}" method="POST" onsubmit="return confirm('Remover {{ c.nome }} da fila de espera?')">
                        <button type="submit" class="btn btn-warning" style="padding: 6px 12px; font-size: 14px;">
                            Remover da Fila
                        </button>
                    </form>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #a17c00; margin-bottom: 20px;">Nenhum cooperado na fila de espera no momento.</p>
    {% endif %}

    <!-- Se√ß√£o de Cooperados -->
    <h2 class="section-title">
        <span style="margin-right: 10px;">üë•</span>
        Cooperados Cadastrados
    </h2>
    
    {% if cooperados %}
        <div class="cooperados-list">
            {% for c in cooperados %}
                <div class="cooperado-card" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <div class="cooperado-name">{{ c.nome }}</div>
                        <div style="color: #718096; font-size: 14px;">
                            Cooperado ativo
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        {% if not c.em_fila_espera %}
                        <form action="{{ url_for('alterar_fila_espera', cooperado_id=c.id) }}" method="POST" onsubmit="return confirm('Adicionar {{ c.nome }} √† fila de espera?')">
                            <button type="submit" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                Adicionar √† Fila
                            </button>
                        </form>
                        {% else %}
                        <span style="color: #a17c00; font-weight: bold; align-self: center;">Na fila de espera</span>
                        {% endif %}
                        <form action="{{ url_for('excluir_cooperado', cooperado_id=c.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir o cooperado {{ c.nome }}? Esta a√ß√£o n√£o pode ser desfeita.')">
                            <button type="submit" class="btn btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                Excluir
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #718096;">
            <p>Nenhum cooperado cadastrado ainda.</p>
            <a href="{{ url_for('cadastrar_cooperado') }}" class="btn" style="margin-top: 15px;">
                Cadastrar Primeiro Cooperado
            </a>
        </div>
    {% endif %}

    <!-- Se√ß√£o de Entregas -->
    <h2 class="section-title" style="margin-top: 40px;">
        <span style="margin-right: 10px;">üì¶</span>
        Gest√£o de Entregas
    </h2>
    
    {% if entregas %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Valor</th>
                        <th>Hora do Pedido</th>
                        <th>Hora Atribu√≠da</th>
                        <th>Cooperado</th>
                        <th>Status Pagamento</th>
                        <th>Status Entrega</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in entregas %}
                    <tr>
                        <td><strong>#{{ e.id }}</strong></td>
                        <td>{{ e.descricao }}</td>
                        <td><strong>R$ {{ "%.2f"|format(e.valor or 0) }}</strong></td>
                        <td>{{ e.hora_pedido|utc_to_brt }}</td>
                        <td>
                            {% if e.hora_atribuida %}
                                {{ e.hora_atribuida|utc_to_brt }}
                            {% else %}
                                <span style="color: #718096;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if e.cooperado %}
                                <strong>{{ e.cooperado.nome }}</strong>
                            {% else %}
                                <span style="color: #718096;">N√£o atribu√≠do</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-{{ e.status_pagamento }}">
                                {% if e.status_pagamento == 'pendente' %}
                                    Pendente
                                {% else %}
                                    Pago
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="status-{{ e.status_entrega|replace(' ', '-') }}">
                                {% if e.status_entrega == 'pendente' %}
                                    Pendente
                                {% elif e.status_entrega == 'em rota' %}
                                    Em Rota
                                {% else %}
                                    Entregue
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('editar_entrega', entrega_id=e.id) }}" class="btn" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;">
                                Editar
                            </a>

                            <form action="{{ url_for('excluir_entrega', entrega_id=e.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir a entrega #{{ e.id }}? Esta a√ß√£o n√£o pode ser desfeita.')">
                                <button type="submit" class="btn btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                    Excluir
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #718096;">
            <p>Nenhuma entrega cadastrada ainda.</p>
            <a href="{{ url_for('cadastrar_entrega') }}" class="btn" style="margin-top: 15px;">
                Cadastrar Primeira Entrega
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
